<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <title>Libreria personale</title>

  <!-- Icona tab browser -->
  <link rel="icon" type="image/x-icon" href="foto.ico">

  <!-- PWA manifest -->
  <link rel="manifest" href="manifest.webmanifest">

  <!-- Colore barra indirizzi su smartphone -->
  <meta name="theme-color" content="#3E2C23">

  <!-- Responsive -->
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Font (titoli pi√π eleganti + testo moderno) -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@500;600&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">

  <style>
    :root {
      /* Palette "antico + moderno" */
      --bg: #3E2C23;           /* marrone cuoio sfondo principale */
      --bg-soft: #4A3529;
      --card: #F5ECD9;         /* avorio caldo per card */
      --card-soft: #EFE2C8;
      --accent: #6A7F94;       /* blu grigio */
      --accent-hover: #C9A86B; /* oro antico per hover */
      --accent-soft: rgba(106,127,148,0.10);
      --text: #2C2C2C;         /* grigio lavagna per testo principale */
      --text-soft: #5C5C5C;
      --border: #C9A86B;       /* oro antico per bordi */
      --danger: #B9413E;
      --success: #4F7C54;
      --radius-lg: 12px;
      --radius-xl: 18px;
      --shadow-soft: 0 18px 40px rgba(0,0,0,0.45);
      --transition-fast: 0.18s ease-out;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: "Inter", system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      background:
        radial-gradient(circle at top, rgba(201,168,107,0.25), transparent 55%),
        radial-gradient(circle at bottom, rgba(0,0,0,0.65), transparent 60%),
        var(--bg);
      color: var(--card);
      min-height: 100vh;
      padding: 32px 16px;
      display: flex;
      justify-content: center;
      align-items: flex-start;
    }

    .app-shell {
      width: 100%;
      max-width: 1100px;
      background:
        linear-gradient(130deg, rgba(0,0,0,0.55), rgba(0,0,0,0.75)),
        radial-gradient(circle at top left, rgba(201,168,107,0.20), transparent 55%);
      border-radius: 28px;
      padding: 24px 24px 28px;
      box-shadow: var(--shadow-soft);
      border: 1px solid rgba(201,168,107,0.55);
      backdrop-filter: blur(10px);
    }

    @media (min-width: 768px) {
      .app-shell {
        padding: 28px 32px 32px;
      }
    }

    .app-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 16px;
      margin-bottom: 24px;
    }

    .app-title {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .app-title h1 {
      font-family: "Cormorant Garamond", serif;
      font-size: 28px;
      font-weight: 600;
      letter-spacing: 0.03em;
      display: flex;
      align-items: center;
      gap: 10px;
      color: #F9F3E5;
    }

    .app-pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 11px;
      padding: 4px 10px;
      border-radius: 999px;
      background: rgba(245,236,217,0.06);
      border: 1px solid rgba(201,168,107,0.65);
      color: #F5ECD9;
    }

    .app-title span.subtitle {
      font-size: 12px;
      color: rgba(245,236,217,0.85);
    }

    .app-badge {
      font-size: 11px;
      padding: 4px 11px;
      border-radius: 999px;
      background: rgba(79,124,84,0.16);
      color: #D8F3DC;
      border: 1px solid rgba(79,124,84,0.75);
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .app-badge-dot {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: #80ED99;
      box-shadow: 0 0 0 3px rgba(128,237,153,0.35);
    }

    /* Layout principale */
    .layout {
      display: grid;
      grid-template-columns: minmax(0, 1.3fr) minmax(0, 1.15fr);
      gap: 20px;
    }

    @media (max-width: 900px) {
      .layout {
        grid-template-columns: 1fr;
      }
    }

    .left-panel, .right-panel {
      background: radial-gradient(circle at top, rgba(255,255,255,0.04), transparent 85%),
                  rgba(0,0,0,0.35);
      border-radius: 22px;
      border: 1px solid rgba(201,168,107,0.4);
      padding: 16px 16px 18px;
      box-shadow: 0 10px 32px rgba(0,0,0,0.7);
    }

    @media (min-width: 768px) {
      .left-panel, .right-panel {
        padding: 18px 18px 22px;
      }
    }

    .panel-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 16px;
    }

    .panel-title {
      font-size: 14px;
      font-weight: 500;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      display: flex;
      align-items: center;
      gap: 8px;
      color: #F5ECD9;
    }

    .panel-title-icon {
      width: 24px;
      height: 24px;
      border-radius: 999px;
      background: radial-gradient(circle at 30% 0, #F5ECD9, #C9A86B);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 13px;
      color: #3E2C23;
      box-shadow: 0 0 0 1px rgba(245,236,217,0.8);
    }

    .panel-subtitle {
      font-size: 11px;
      color: rgba(245,236,217,0.75);
    }

    /* Card form */
    .form-card {
      background: var(--card);
      border-radius: var(--radius-xl);
      border: 1px solid var(--border);
      padding: 14px 14px 12px;
      margin-bottom: 16px;
      box-shadow: 0 12px 28px rgba(0,0,0,0.35);
      color: var(--text);
    }

    @media (min-width: 768px) {
      .form-card {
        padding: 16px;
      }
    }

    .form-row {
      display: flex;
      gap: 10px;
      margin-bottom: 10px;
      flex-wrap: wrap;
    }

    .form-group {
      flex: 1;
      min-width: 130px;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    label {
      font-size: 11px;
      color: var(--text-soft);
      font-weight: 500;
    }

    input, select, textarea {
      background: #FDF7EA;
      border-radius: 8px;
      border: 1px solid rgba(201,168,107,0.7);
      padding: 7px 9px;
      font-size: 12px;
      color: var(--text);
      outline: none;
      transition: border var(--transition-fast), box-shadow var(--transition-fast), background var(--transition-fast), transform 0.05s;
    }

    input:focus, select:focus, textarea:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(106,127,148,0.7);
      background: #FFF9ED;
      transform: translateY(-0.5px);
    }

    input::placeholder, textarea::placeholder {
      color: rgba(124,124,124,0.75);
    }

    textarea {
      resize: vertical;
      min-height: 60px;
      max-height: 130px;
    }

    .divider {
      height: 1px;
      background: linear-gradient(to right, transparent, rgba(201,168,107,0.7), transparent);
      margin: 10px 0 8px;
    }

    .form-actions {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
    }

    .btn {
      border: none;
      border-radius: 999px;
      padding: 7px 14px;
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 7px;
      transition: transform 0.08s ease-out, box-shadow 0.08s ease-out, background var(--transition-fast), border var(--transition-fast), color var(--transition-fast);
      white-space: nowrap;
    }

    .btn-primary {
      background: var(--accent);
      color: #F5ECD9;
      box-shadow: 0 10px 24px rgba(0,0,0,0.45);
      border: 1px solid rgba(42,57,72,0.5);
    }

    .btn-primary:hover {
      background: var(--accent-hover);
      color: #3E2C23;
      border-color: rgba(201,168,107,0.9);
      transform: translateY(-1px);
      box-shadow: 0 14px 30px rgba(0,0,0,0.55);
    }

    .btn-secondary {
      background: #6A7F94;
      color: #F5ECD9;
      border: 1px solid #2F3E4F;
      box-shadow: 0 8px 18px rgba(0,0,0,0.35);
    }

    .btn-secondary:hover {
      background: #C9A86B;
      color: #3E2C23;
      border-color: #C9A86B;
      transform: translateY(-1px);
    }

    .btn-ghost {
      background: rgba(201,168,107,0.10);
      color: #3E2C23;
      border-radius: 999px;
      padding: 4px 9px;
      font-size: 11px;
      border: 1px solid rgba(201,168,107,0.7);
    }

    .btn-ghost:hover {
      background: rgba(201,168,107,0.22);
      color: #2C2C2C;
    }

    .btn-danger {
      background: rgba(185,65,62,0.08);
      color: #F5B5AE;
      border-radius: 999px;
      border: 1px solid rgba(185,65,62,0.65);
      padding: 4px 9px;
      font-size: 11px;
    }

    .btn-danger:hover {
      background: rgba(185,65,62,0.18);
      border-color: rgba(241,112,110,0.9);
      color: #FFE2DE;
      transform: translateY(-1px);
    }

    /* Barra di ricerca */
    .search-bar {
      display: flex;
      gap: 8px;
      align-items: center;
      margin-bottom: 10px;
      margin-top: 4px;
    }

    .search-input-wrapper {
      flex: 1;
      display: flex;
      align-items: center;
      gap: 6px;
      background: var(--card);
      border-radius: 999px;
      border: 1px solid rgba(201,168,107,0.7);
      padding: 4px 9px;
      box-shadow: 0 6px 14px rgba(0,0,0,0.25);
      color: var(--text);
    }

    .search-input-wrapper:focus-within {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(106,127,148,0.7);
    }

    .search-icon {
      font-size: 12px;
      color: var(--text-soft);
    }

    #searchInput {
      border: none;
      background: transparent;
      padding: 4px 0;
      font-size: 12px;
      color: var(--text);
      width: 100%;
      outline: none;
    }

    /* Tabs */
    .tabs {
      display: flex;
      gap: 8px;
      border-radius: 999px;
      padding: 4px;
      background: rgba(0,0,0,0.35);
      border: 1px solid rgba(201,168,107,0.45);
      margin-bottom: 10px;
      overflow-x: auto;
    }

    .tab {
      flex: 1;
      font-size: 11px;
      padding: 5px 8px;
      border-radius: 999px;
      border: none;
      background: transparent;
      color: rgba(245,236,217,0.8);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      white-space: nowrap;
      transition: background var(--transition-fast), color var(--transition-fast), transform 0.08s;
    }

    .tab span.count-pill {
      font-size: 9px;
      background: rgba(245,236,217,0.06);
      border-radius: 999px;
      padding: 1px 6px;
      border: 1px solid rgba(201,168,107,0.6);
    }

    .tab.active {
      background: rgba(245,236,217,0.12);
      color: #FDF7EA;
      box-shadow: 0 0 0 1px rgba(201,168,107,0.9);
      transform: translateY(-0.5px);
    }

    .tab.active span.count-pill {
      background: rgba(201,168,107,0.16);
      border-color: rgba(201,168,107,0.9);
    }

    /* Lista libri */
    .books-list {
      max-height: 460px;
      overflow-y: auto;
      padding-right: 4px;
      margin-right: -4px;
    }

    .books-list-empty {
      font-size: 12px;
      color: rgba(245,236,217,0.8);
      padding: 18px 10px 12px;
      text-align: center;
    }

    .book-card {
      background: var(--card);
      border-radius: 16px;
      padding: 10px 11px 9px;
      border: 1px solid var(--border);
      margin-bottom: 8px;
      display: flex;
      gap: 10px;
      align-items: flex-start;
      transition: transform 0.08s ease-out, box-shadow 0.08s ease-out, border var(--transition-fast), background var(--transition-fast);
      box-shadow: 0 8px 20px rgba(0,0,0,0.3);
      color: var(--text);
    }

    .book-card:hover {
      transform: translateY(-1px);
      box-shadow: 0 12px 26px rgba(0,0,0,0.45);
      border-color: rgba(201,168,107,0.95);
      background: var(--card-soft);
    }

    .book-cover {
      width: 40px;
      height: 56px;
      border-radius: 8px;
      background: linear-gradient(135deg, #C9A86B, #8C6C3A);
      border: 1px solid rgba(120,85,40,0.75);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      color: #F5ECD9;
      flex-shrink: 0;
      font-family: "Cormorant Garamond", serif;
      font-weight: 600;
      overflow: hidden;
    }

    .book-cover img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      border-radius: inherit;
      display: block;
    }

    .book-main {
      flex: 1;
      min-width: 0;
    }

    .book-title-row {
      display: flex;
      justify-content: space-between;
      gap: 6px;
      align-items: flex-start;
      margin-bottom: 3px;
    }

    .book-title {
      font-size: 13px;
      font-weight: 600;
      letter-spacing: 0.02em;
      color: var(--text);
    }

    .book-meta {
      font-size: 11px;
      color: var(--text-soft);
      margin-bottom: 4px;
    }

    .badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 10px;
      padding: 3px 7px;
      border-radius: 999px;
      border: 1px solid rgba(201,168,107,0.7);
      background: #F9F0DE;
      color: var(--text-soft);
    }

    .badge-dot {
      width: 6px;
      height: 6px;
      border-radius: 999px;
    }

    .badge-dot.green { background: #4F7C54; }
    .badge-dot.amber { background: #C9A86B; }
    .badge-dot.blue  { background: #6A7F94; }
    .badge-dot.slate { background: #7A7A7A; }

    .price-row {
      font-size: 11px;
      color: var(--text-soft);
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 4px;
    }

    .price-value {
      font-weight: 500;
      color: #B76E40;
    }

    .book-footer {
      display: flex;
      justify-content: space-between;
      gap: 8px;
      align-items: center;
      margin-top: 4px;
      flex-wrap: wrap;
    }

    .book-footer-left {
      display: flex;
      gap: 4px;
      flex-wrap: wrap;
    }

    .book-footer-right {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
    }

    .rating-stars {
      font-size: 11px;
      color: #C9A86B;
      display: inline-flex;
      gap: 1px;
    }

    .review-snippet {
      font-size: 11px;
      color: var(--text-soft);
      margin-top: 2px;
      font-style: italic;
    }

    /* Pannello destro: statistiche + categorie + backup */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 8px;
      margin-bottom: 10px;
    }

    .stat-card {
      background: var(--card);
      border-radius: 14px;
      padding: 10px 10px 9px;
      border: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      gap: 3px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.35);
      color: var(--text);
    }

    .stat-label {
      font-size: 11px;
      color: var(--text-soft);
    }

    .stat-value {
      font-size: 16px;
      font-weight: 600;
      letter-spacing: 0.02em;
      color: var(--text);
    }

    .stat-pill {
      font-size: 10px;
      color: var(--text-soft);
      background: #F9F0DE;
      border-radius: 999px;
      padding: 2px 7px;
      border: 1px solid rgba(201,168,107,0.7);
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .stat-dot {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: #6A7F94;
    }

    .genre-list {
      font-size: 11px;
      color: var(--text-soft);
      margin-top: 4px;
      max-height: 120px;
      overflow-y: auto;
    }

    .genre-row {
      display: flex;
      justify-content: space-between;
      gap: 6px;
      margin-bottom: 2px;
    }

    .backup-card {
      margin-top: 12px;
      background: var(--card);
      border-radius: 14px;
      padding: 10px 10px 9px;
      border: 1px solid var(--border);
      font-size: 11px;
      color: var(--text-soft);
      display: flex;
      flex-direction: column;
      gap: 8px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.35);
    }

    .backup-actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    textarea.backup-area {
      font-size: 11px;
      min-height: 70px;
      background: #FDF7EA;
      border-radius: 8px;
      border: 1px solid rgba(201,168,107,0.7);
      color: var(--text);
    }

    /* Toast */
    .toast {
      position: fixed;
      bottom: 18px;
      right: 16px;
      padding: 9px 12px;
      border-radius: 999px;
      font-size: 11px;
      background: rgba(62,44,35,0.96);
      color: #F5ECD9;
      border: 1px solid rgba(201,168,107,0.7);
      box-shadow: 0 16px 35px rgba(0,0,0,0.75);
      opacity: 0;
      transform: translateY(10px);
      pointer-events: none;
      transition: opacity 0.16s ease-out, transform 0.16s ease-out;
      display: flex;
      align-items: center;
      gap: 8px;
      z-index: 50;
    }

    .toast.visible {
      opacity: 1;
      transform: translateY(0);
    }

    .toast-dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: #4F7C54;
      box-shadow: 0 0 0 3px rgba(79,124,84,0.4);
    }

    .toast-error .toast-dot {
      background: #B9413E;
      box-shadow: 0 0 0 3px rgba(185,65,62,0.4);
    }

    /* Modal recensione */
    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.55);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 40;
      padding: 16px;
    }

    .modal-backdrop.visible {
      display: flex;
    }

    .modal {
      width: 100%;
      max-width: 460px;
      background: var(--card);
      border-radius: 20px;
      border: 1px solid var(--border);
      box-shadow: 0 22px 50px rgba(0,0,0,0.7);
      padding: 16px 16px 14px;
      color: var(--text);
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      gap: 10px;
      align-items: center;
      margin-bottom: 8px;
    }

    .modal-title {
      font-size: 14px;
      font-weight: 600;
      font-family: "Cormorant Garamond", serif;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      color: var(--text);
    }

    .modal-close {
      border: none;
      background: rgba(245,236,217,0.85);
      border-radius: 999px;
      padding: 3px 7px;
      font-size: 11px;
      color: var(--text-soft);
      cursor: pointer;
      border: 1px solid rgba(201,168,107,0.7);
    }

    .modal-close:hover {
      background: #FDF7EA;
    }

    .modal-body {
      font-size: 12px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .rating-select {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .rating-select select {
      max-width: 80px;
    }

    .modal-footer {
      margin-top: 10px;
      display: flex;
      justify-content: space-between;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap;
    }

    .helper-text {
      font-size: 11px;
      color: var(--text-soft);
    }
  </style>
</head>
<body>
  <div class="app-shell">
    <header class="app-header">
      <div class="app-title">
        <h1>
          Libreria personale
          <span class="app-pill">
            <span>üìö</span>
            <span>Traccia letture, costi e recensioni</span>
          </span>
        </h1>
        <span class="subtitle">Una piccola libreria digitale in stile antico, per organizzare libri, prezzi, stato di lettura e giudizi.</span>
      </div>
      <div class="app-badge">
        <span class="app-badge-dot"></span>
        <span>Dati salvati solo sul tuo PC</span>
      </div>
    </header>

    <div class="layout">
      <!-- Pannello sinistro -->
      <section class="left-panel">
        <div class="panel-header">
          <div>
            <div class="panel-title">
              <div class="panel-title-icon">Ôºã</div>
              Nuovo libro
            </div>
            <div class="panel-subtitle">Compila i campi principali; potrai sempre modificare in seguito.</div>
          </div>
        </div>

        <div class="form-card">
          <div class="form-row">
            <div class="form-group">
              <label for="title">Titolo *</label>
              <input id="title" type="text" placeholder="Es. Il nome della rosa" />
            </div>
            <div class="form-group">
              <label for="author">Autore *</label>
              <input id="author" type="text" placeholder="Es. Umberto Eco" />
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="isbn">ISBN</label>
              <input id="isbn" type="text" placeholder="Es. 9788806173662" />
            </div>
            <div class="form-group">
              <label for="category">Categoria / Genere</label>
              <input id="category" type="text" placeholder="Es. Romanzo, Saggio, Fantasy‚Ä¶" />
            </div>
            <div class="form-group">
              <label for="pages">Pagine</label>
              <input id="pages" type="number" min="1" placeholder="Es. 350" />
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="priority">Priorit√†</label>
              <select id="priority">
                <option value="media">Media</option>
                <option value="alta">Alta</option>
                <option value="bassa">Bassa</option>
              </select>
            </div>
            <div class="form-group">
              <label for="price">Prezzo indicativo (‚Ç¨)</label>
              <input id="price" type="number" step="0.01" min="0" placeholder="Es. 18.90" />
            </div>
            <div class="form-group">
              <label for="storeUrl">Link acquisto (facoltativo)</label>
              <input id="storeUrl" type="url" placeholder="URL Amazon / IBS / altro" />
            </div>
          </div>

          <!-- URL copertina, compilato automaticamente da Google Books ma modificabile -->
          <div class="form-row">
            <div class="form-group">
              <label for="coverUrl">URL copertina (facoltativo)</label>
              <input id="coverUrl" type="url" placeholder="Lascia vuoto: verr√† compilato da Google Books" />
            </div>
          </div>

          <div class="divider"></div>

          <div class="form-actions">
            <!-- Sinistra: Google Books + store online -->
            <div style="display:flex; gap:6px; flex-wrap:wrap; align-items:center;">
              <button class="btn btn-secondary" id="fetchBookDataBtn" type="button">
                üîé Completa da Google Books
              </button>
              <button class="btn btn-ghost" id="amazonSearchBtn" type="button">
                Amazon
              </button>
              <button class="btn btn-ghost" id="feltrinelliSearchBtn" type="button">
                laFeltrinelli
              </button>
              <button class="btn btn-ghost" id="ibsSearchBtn" type="button">
                IBS
              </button>
            </div>

            <!-- Destra: reset + salva -->
            <div style="display:flex; gap:6px; align-items:center; flex-wrap:wrap;">
              <button class="btn btn-ghost" id="resetFormBtn" type="button">
                Annulla
              </button>
              <button class="btn btn-primary" id="addBookBtn" type="button">
                Salva libro
              </button>
            </div>
          </div>
        </div>

        <!-- Barra di ricerca -->
        <div class="search-bar">
          <div class="search-input-wrapper">
            <span class="search-icon">üîç</span>
            <input id="searchInput" type="text" placeholder="Cerca per titolo o autore..." />
          </div>
          <button class="btn btn-ghost" id="clearSearchBtn" type="button">
            Pulisci
          </button>
        </div>

        <div class="tabs" id="statusTabs">
          <button class="tab active" data-status="DA_LEGGERE">
            Da leggere
            <span class="count-pill" id="countDaLeggere">0</span>
          </button>
          <button class="tab" data-status="IN_LETTURA">
            In lettura
            <span class="count-pill" id="countInLettura">0</span>
          </button>
          <button class="tab" data-status="LETTO">
            Letti &amp; recensioni
            <span class="count-pill" id="countLetti">0</span>
          </button>
          <button class="tab" data-status="ALL">
            Tutti
            <span class="count-pill" id="countTotale">0</span>
          </button>
        </div>

        <div class="books-list" id="booksList"></div>
      </section>

      <!-- Pannello destro -->
      <section class="right-panel">
        <div class="panel-header">
          <div>
            <div class="panel-title">
              <div class="panel-title-icon">üìä</div>
              Panoramica letture
            </div>
            <div class="panel-subtitle">Statistiche, generi pi√π letti, categorie e backup.</div>
          </div>
        </div>

        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-label">Libri totali</div>
            <div class="stat-value" id="statTotal">0</div>
            <div class="stat-pill">
              <span class="stat-dot"></span>
              <span><span id="statDaLeggere">0</span> da leggere</span>
            </div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Libri letti</div>
            <div class="stat-value" id="statRead">0</div>
            <div class="stat-pill">
              ‚≠ê <span id="statAvgRating">‚Äî</span> voto medio
            </div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Pagine totali lette</div>
            <div class="stat-value" id="statPages">0</div>
            <div class="stat-pill">
              üìÖ <span id="statYears">0</span> anno/i coperti
            </div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Tempo medio lettura</div>
            <div class="stat-value" id="statAvgDays">‚Äî</div>
            <div class="stat-pill">
              ‚è±Ô∏è giorni per libro
            </div>
          </div>
        </div>

        <div class="stat-card">
          <div class="stat-label">Generi pi√π letti (libri finiti)</div>
          <div class="genre-list" id="genreList"></div>
        </div>

        <div class="stat-card">
          <div class="stat-label">Categorie libreria (tutti i libri)</div>
          <div class="genre-list" id="categoriesList"></div>
        </div>

        <div class="backup-card">
          <div>
            <div style="display:flex; justify-content:space-between; align-items:center; gap:8px; margin-bottom:4px;">
              <span>Backup manuale</span>
              <span style="font-size:10px; color:var(--text-soft);">JSON copiabile</span>
            </div>
            <p>Puoi esportare i dati in formato testo (JSON) per tenerne una copia, oppure incollare un backup esistente.</p>
          </div>
          <div class="backup-actions">
            <button class="btn btn-secondary" id="exportBtn" type="button">Esporta</button>
            <button class="btn btn-secondary" id="importBtn" type="button">Importa</button>
            <button class="btn btn-danger" id="clearAllBtn" type="button">Cancella tutto</button>
          </div>
          <textarea class="backup-area" id="backupArea" placeholder="Qui comparir√† il backup in JSON, oppure incolla qui un backup da importare."></textarea>
        </div>
      </section>
    </div>
  </div>

  <!-- Toast -->
  <div class="toast" id="toast">
    <div class="toast-dot"></div>
    <div id="toastMessage">Messaggio</div>
  </div>

  <!-- Modal recensione -->
  <div class="modal-backdrop" id="reviewModalBackdrop">
    <div class="modal">
      <div class="modal-header">
        <div>
          <div class="modal-title" id="reviewModalTitle">Dettagli &amp; recensione</div>
          <div class="panel-subtitle" id="reviewModalSubtitle" style="color:var(--text-soft);"></div>
        </div>
        <button class="modal-close" id="reviewModalCloseBtn" type="button">Chiudi</button>
      </div>
      <div class="modal-body">
        <div class="rating-select">
          <label for="reviewRating">Voto</label>
          <select id="reviewRating">
            <option value="">‚Äî</option>
            <option value="1">1 ‚òÖ</option>
            <option value="2">2 ‚òÖ‚òÖ</option>
            <option value="3">3 ‚òÖ‚òÖ‚òÖ</option>
            <option value="4">4 ‚òÖ‚òÖ‚òÖ‚òÖ</option>
            <option value="5">5 ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ</option>
          </select>
        </div>
        <div class="form-group">
          <label for="reviewText">Recensione personale</label>
          <textarea id="reviewText" placeholder="Impressioni generali, cosa ti √® piaciuto, cosa no, a chi lo consiglieresti‚Ä¶"></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <div class="helper-text">
          Puoi aggiornare la recensione ogni volta che vuoi.
        </div>
        <button class="btn btn-primary" id="saveReviewBtn" type="button">
          Salva recensione
        </button>
      </div>
    </div>
  </div>

  <script>
    const STORAGE_KEY = "myLibraryAppData_v1";

    function loadBooks() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return [];
        const parsed = JSON.parse(raw);
        if (!Array.isArray(parsed)) return [];
        return parsed;
      } catch (e) {
        console.error("Errore lettura storage:", e);
        return [];
      }
    }

    function saveBooks(books) {
      try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(books));
      } catch (e) {
        console.error("Errore salvataggio storage:", e);
      }
    }

    function generateId() {
      return "book_" + Math.random().toString(36).slice(2) + "_" + Date.now().toString(36);
    }

    let books = loadBooks();
    let activeStatusFilter = "DA_LEGGERE";
    let reviewModalBookId = null;
    let activeCategoryFilter = null;
    let searchQuery = "";

    const $ = (id) => document.getElementById(id);

    function showToast(message, isError = false) {
      const toast = $("toast");
      const msg = $("toastMessage");
      msg.textContent = message;
      if (isError) {
        toast.classList.add("toast-error");
      } else {
        toast.classList.remove("toast-error");
      }
      toast.classList.add("visible");
      setTimeout(() => {
        toast.classList.remove("visible");
      }, 2600);
    }

    function shortDate(iso) {
      if (!iso) return "‚Äî";
      const d = new Date(iso);
      if (isNaN(d.getTime())) return "‚Äî";
      return d.toLocaleDateString("it-IT", { day: "2-digit", month: "2-digit", year: "2-digit" });
    }

    function sanitizeNumber(value) {
      if (value === "" || value === null || value === undefined) return null;
      const n = Number(value);
      return isNaN(n) ? null : n;
    }

    function getInitials(title) {
      if (!title) return "üìï";
      const parts = title.trim().split(/\s+/);
      const first = parts[0] ? parts[0][0].toUpperCase() : "";
      const second = parts[1] ? parts[1][0].toUpperCase() : "";
      const result = first + second;
      return result || "üìï";
    }

    function getStatusLabel(status) {
      switch (status) {
        case "DA_LEGGERE": return "Da leggere";
        case "IN_LETTURA": return "In lettura";
        case "LETTO": return "Letto";
        default: return status;
      }
    }

    function getStatusDotColor(status) {
      switch (status) {
        case "DA_LEGGERE": return "blue";
        case "IN_LETTURA": return "amber";
        case "LETTO": return "green";
        default: return "slate";
      }
    }

    function renderStars(rating) {
      if (!rating) return "";
      let result = "";
      for (let i = 1; i <= 5; i++) {
        result += i <= rating ? "‚òÖ" : "‚òÜ";
      }
      return result;
    }

    function renderBooks() {
      const listEl = $("booksList");
      listEl.innerHTML = "";

      let filtered = activeStatusFilter === "ALL"
        ? books
        : books.filter(b => b.status === activeStatusFilter);

      if (activeCategoryFilter) {
        filtered = filtered.filter(b => {
          const cat = (b.category || "").trim().toLowerCase();
          return cat === activeCategoryFilter.toLowerCase();
        });
      }

      if (searchQuery) {
        const q = searchQuery.toLowerCase();
        filtered = filtered.filter(b => {
          const t = (b.title || "").toLowerCase();
          const a = (b.author || "").toLowerCase();
          return t.includes(q) || a.includes(q);
        });
      }

      if (!filtered.length) {
        listEl.innerHTML = '<div class="books-list-empty">Nessun libro per questo filtro. Modifica la ricerca, la categoria o la scheda selezionata.</div>';
        updateCounts();
        updateStats();
        updateCategoriesView();
        return;
      }

      filtered
        .slice()
        .sort((a, b) => new Date(b.dateAdded || 0) - new Date(a.dateAdded || 0))
        .forEach(book => {
          const card = document.createElement("article");
          card.className = "book-card";

          const cover = document.createElement("div");
          cover.className = "book-cover";

          if (book.coverUrl) {
            const img = document.createElement("img");
            img.src = book.coverUrl;
            img.alt = book.title || "Copertina libro";
            cover.appendChild(img);
          } else {
            cover.textContent = getInitials(book.title);
          }

          const main = document.createElement("div");
          main.className = "book-main";

          const titleRow = document.createElement("div");
          titleRow.className = "book-title-row";

          const titleEl = document.createElement("div");
          titleEl.className = "book-title";
          titleEl.textContent = book.title || "(senza titolo)";

          const statusBadge = document.createElement("div");
          statusBadge.className = "badge";
          const dot = document.createElement("span");
          dot.className = "badge-dot " + getStatusDotColor(book.status);
          statusBadge.appendChild(dot);
          const statusText = document.createElement("span");
          statusText.textContent = getStatusLabel(book.status);
          statusBadge.appendChild(statusText);

          titleRow.appendChild(titleEl);
          titleRow.appendChild(statusBadge);

          const meta = document.createElement("div");
          meta.className = "book-meta";
          const parts = [];
          if (book.author) parts.push(book.author);
          if (book.category) parts.push(book.category);
          if (book.pages) parts.push(book.pages + " pp.");
          if (book.priority) parts.push("Priorit√† " + book.priority);
          meta.textContent = parts.join(" ‚Ä¢ ");

          const priceRow = document.createElement("div");
          priceRow.className = "price-row";
          if (book.price != null) {
            const pLabel = document.createElement("span");
            pLabel.textContent = "Prezzo:";
            const pVal = document.createElement("span");
            pVal.className = "price-value";
            pVal.textContent = book.price.toFixed(2) + " ‚Ç¨";
            priceRow.appendChild(pLabel);
            priceRow.appendChild(pVal);
          } else {
            priceRow.textContent = "Prezzo non indicato";
          }
          if (book.storeUrl) {
            const link = document.createElement("a");
            link.href = book.storeUrl;
            link.target = "_blank";
            link.rel = "noopener noreferrer";
            link.textContent = "Apri store";
            link.style.fontSize = "11px";
            link.style.textDecoration = "none";
            link.style.color = "#6A7F94";
            priceRow.appendChild(link);
          }

          const footer = document.createElement("div");
          footer.className = "book-footer";

          const footerLeft = document.createElement("div");
          footerLeft.className = "book-footer-left";

          const dateInfo = document.createElement("span");
          dateInfo.className = "badge";
          const dateDot = document.createElement("span");
          dateDot.className = "badge-dot slate";
          dateInfo.appendChild(dateDot);
          let dateLabel = "Inserito " + shortDate(book.dateAdded);
          if (book.status === "IN_LETTURA" && book.dateStart) {
            dateLabel = "Iniziato " + shortDate(book.dateStart);
          }
          if (book.status === "LETTO" && book.dateEnd) {
            dateLabel = "Finito " + shortDate(book.dateEnd);
          }
          dateInfo.appendChild(document.createTextNode(dateLabel));
          footerLeft.appendChild(dateInfo);

          if (book.status === "LETTO" && book.rating) {
            const ratingEl = document.createElement("span");
            ratingEl.className = "rating-stars";
            ratingEl.textContent = renderStars(book.rating);
            footerLeft.appendChild(ratingEl);
          }

          const footerRight = document.createElement("div");
          footerRight.className = "book-footer-right";

          const btnDetails = document.createElement("button");
          btnDetails.className = "btn btn-ghost";
          btnDetails.type = "button";
          btnDetails.textContent = "Dettagli";
          btnDetails.addEventListener("click", () => openReviewModal(book.id));
          footerRight.appendChild(btnDetails);

          if (book.status === "DA_LEGGERE") {
            const btnStart = document.createElement("button");
            btnStart.className = "btn btn-secondary";
            btnStart.type = "button";
            btnStart.textContent = "Inizia lettura";
            btnStart.addEventListener("click", () => updateStatus(book.id, "IN_LETTURA"));
            footerRight.appendChild(btnStart);
          }

          if (book.status === "IN_LETTURA" || book.status === "DA_LEGGERE") {
            const btnMarkRead = document.createElement("button");
            btnMarkRead.className = "btn btn-primary";
            btnMarkRead.type = "button";
            btnMarkRead.textContent = "Segna come letto";
            btnMarkRead.addEventListener("click", () => {
              updateStatus(book.id, "LETTO");
              openReviewModal(book.id);
            });
            footerRight.appendChild(btnMarkRead);
          }

          const btnDelete = document.createElement("button");
          btnDelete.className = "btn btn-danger";
          btnDelete.type = "button";
          btnDelete.textContent = "Rimuovi";
          btnDelete.addEventListener("click", () => deleteBook(book.id));
          footerRight.appendChild(btnDelete);

          footer.appendChild(footerLeft);
          footer.appendChild(footerRight);

          main.appendChild(titleRow);
          main.appendChild(meta);
          main.appendChild(priceRow);

          if (book.reviewText && book.status === "LETTO") {
            const rev = document.createElement("div");
            rev.className = "review-snippet";
            const text = book.reviewText.length > 110
              ? book.reviewText.slice(0, 110) + "‚Ä¶"
              : book.reviewText;
            rev.textContent = "‚Äú" + text + "‚Äù";
            main.appendChild(rev);
          }

          main.appendChild(footer);

          card.appendChild(cover);
          card.appendChild(main);

          listEl.appendChild(card);
        });

      updateCounts();
      updateStats();
      updateCategoriesView();
    }

    function updateCounts() {
      const daLeggere = books.filter(b => b.status === "DA_LEGGERE").length;
      const inLettura = books.filter(b => b.status === "IN_LETTURA").length;
      const letti = books.filter(b => b.status === "LETTO").length;
      const tot = books.length;

      $("countDaLeggere").textContent = daLeggere;
      $("countInLettura").textContent = inLettura;
      $("countLetti").textContent = letti;
      $("countTotale").textContent = tot;

      $("statTotal").textContent = tot;
      $("statDaLeggere").textContent = daLeggere;
      $("statRead").textContent = letti;
    }

    function updateStats() {
      const readBooks = books.filter(b => b.status === "LETTO");

      let totalPages = 0;
      let pagesYearsSet = new Set();
      let daysPerBook = [];

      readBooks.forEach(b => {
        if (b.pages) totalPages += b.pages;
        if (b.dateEnd) {
          const y = new Date(b.dateEnd).getFullYear();
          if (!isNaN(y)) pagesYearsSet.add(y);
        }
        if (b.dateStart && b.dateEnd) {
          const start = new Date(b.dateStart);
          const end = new Date(b.dateEnd);
          if (!isNaN(start.getTime()) && !isNaN(end.getTime()) && end >= start) {
            const diffDays = (end - start) / (1000 * 60 * 60 * 24) || 0;
            daysPerBook.push(diffDays);
          }
        }
      });

      $("statPages").textContent = totalPages;
      $("statYears").textContent = pagesYearsSet.size;

      const ratings = readBooks
        .map(b => b.rating)
        .filter(r => typeof r === "number" && !isNaN(r));

      if (ratings.length) {
        const avg = ratings.reduce((a, b) => a + b, 0) / ratings.length;
        $("statAvgRating").textContent = avg.toFixed(1);
      } else {
        $("statAvgRating").textContent = "‚Äî";
      }

      if (daysPerBook.length) {
        const avgDays = daysPerBook.reduce((a, b) => a + b, 0) / daysPerBook.length;
        $("statAvgDays").textContent = avgDays.toFixed(1);
      } else {
        $("statAvgDays").textContent = "‚Äî";
      }

      const genreCounts = {};
      readBooks.forEach(b => {
        if (!b.category) return;
        const key = b.category.trim();
        if (!key) return;
        genreCounts[key] = (genreCounts[key] || 0) + 1;
      });

      const genreListEl = $("genreList");
      genreListEl.innerHTML = "";

      const entries = Object.entries(genreCounts)
        .sort((a, b) => b[1] - a[1]);

      if (!entries.length) {
        genreListEl.textContent = "Non ci sono ancora generi con libri letti.";
        return;
      }

      entries.forEach(([genre, count]) => {
        const row = document.createElement("div");
        row.className = "genre-row";
        const left = document.createElement("span");
        left.textContent = genre;
        const right = document.createElement("span");
        right.textContent = count + " libro/i";
        row.appendChild(left);
        row.appendChild(right);
        genreListEl.appendChild(row);
      });
    }

    function updateCategoriesView() {
      const container = $("categoriesList");
      if (!container) return;

      container.innerHTML = "";

      if (!books.length) {
        container.textContent = "Nessun libro in libreria.";
        return;
      }

      const categoryCounts = {};
      books.forEach(b => {
        let name = (b.category || "").trim();
        if (!name) name = "Senza categoria";
        categoryCounts[name] = (categoryCounts[name] || 0) + 1;
      });

      const entries = Object.entries(categoryCounts)
        .sort((a, b) => {
          if (b[1] !== a[1]) return b[1] - a[1];
          return a[0].localeCompare(b[0], "it");
        });

      entries.forEach(([name, count]) => {
        const row = document.createElement("div");
        row.className = "genre-row";
        row.style.cursor = "pointer";

        if (activeCategoryFilter && name.toLowerCase() === activeCategoryFilter.toLowerCase()) {
          row.style.fontWeight = "600";
          row.style.color = "#2C2C2C";
        }

        const left = document.createElement("span");
        left.textContent = name;

        const right = document.createElement("span");
        right.textContent = count + " libro/i";

        row.appendChild(left);
        row.appendChild(right);

        row.addEventListener("click", () => {
          if (activeCategoryFilter && name.toLowerCase() === activeCategoryFilter.toLowerCase()) {
            activeCategoryFilter = null;
            showToast("Filtro categoria rimosso.");
          } else {
            activeCategoryFilter = name;
            showToast('Filtro categoria: "' + name + '"');
          }
          renderBooks();
        });

        container.appendChild(row);
      });

      const helper = document.createElement("div");
      helper.style.fontSize = "10px";
      helper.style.color = "var(--text-soft)";
      helper.style.marginTop = "4px";
      helper.textContent = "Clicca su una categoria per filtrare, riclicca per togliere il filtro.";
      container.appendChild(helper);
    }

    function addBookFromForm() {
      const title = $("title").value.trim();
      const author = $("author").value.trim();
      const isbn = $("isbn").value.trim();
      const category = $("category").value.trim();
      const pages = sanitizeNumber($("pages").value);
      const priority = $("priority").value || "media";
      const price = sanitizeNumber($("price").value);
      const storeUrl = $("storeUrl").value.trim() || null;
      const coverUrl = $("coverUrl").value.trim() || null;

      if (!title || !author) {
        showToast("Titolo e autore sono obbligatori.", true);
        return;
      }

      const newBook = {
        id: generateId(),
        title,
        author,
        isbn: isbn || null,
        category: category || "",
        pages,
        priority,
        price,
        storeUrl,
        coverUrl,
        status: "DA_LEGGERE",
        dateAdded: new Date().toISOString(),
        dateStart: null,
        dateEnd: null,
        rating: null,
        reviewText: null
      };

      books.push(newBook);
      saveBooks(books);
      renderBooks();
      resetForm();
      showToast('Libro aggiunto alla lista "Da leggere".');
    }

    function resetForm() {
      $("title").value = "";
      $("author").value = "";
      $("isbn").value = "";
      $("category").value = "";
      $("pages").value = "";
      $("priority").value = "media";
      $("price").value = "";
      $("storeUrl").value = "";
      $("coverUrl").value = "";
    }

    function updateStatus(bookId, newStatus) {
      const idx = books.findIndex(b => b.id === bookId);
      if (idx === -1) return;
      const nowIso = new Date().toISOString();

      if (newStatus === "IN_LETTURA" && !books[idx].dateStart) {
        books[idx].dateStart = nowIso;
      }
      if (newStatus === "LETTO") {
        if (!books[idx].dateStart) books[idx].dateStart = nowIso;
        if (!books[idx].dateEnd) books[idx].dateEnd = nowIso;
      }

      books[idx].status = newStatus;
      saveBooks(books);
      renderBooks();
      showToast('Stato aggiornato in "' + getStatusLabel(newStatus) + '".');
    }

    function deleteBook(bookId) {
      if (!confirm("Vuoi davvero rimuovere questo libro?")) return;
      books = books.filter(b => b.id !== bookId);
      saveBooks(books);
      renderBooks();
      showToast("Libro rimosso.");
    }

    function openReviewModal(bookId) {
      reviewModalBookId = bookId;
      const book = books.find(b => b.id === bookId);
      if (!book) return;

      $("reviewModalTitle").textContent = "Dettagli & recensione";
      $("reviewModalSubtitle").textContent = book.title + " ‚Äì " + (book.author || "");
      $("reviewRating").value = book.rating != null ? String(book.rating) : "";
      $("reviewText").value = book.reviewText || "";

      $("reviewModalBackdrop").classList.add("visible");
    }

    function closeReviewModal() {
      $("reviewModalBackdrop").classList.remove("visible");
      reviewModalBookId = null;
    }

    function saveReview() {
      if (!reviewModalBookId) {
        closeReviewModal();
        return;
      }
      const idx = books.findIndex(b => b.id === reviewModalBookId);
      if (idx === -1) {
        closeReviewModal();
        return;
      }
      const ratingVal = sanitizeNumber($("reviewRating").value);
      const reviewText = $("reviewText").value.trim();

      books[idx].rating = ratingVal;
      books[idx].reviewText = reviewText || null;

      if (books[idx].status !== "LETTO") {
        books[idx].status = "LETTO";
        const nowIso = new Date().toISOString();
        if (!books[idx].dateStart) books[idx].dateStart = nowIso;
        if (!books[idx].dateEnd) books[idx].dateEnd = nowIso;
      }

      saveBooks(books);
      renderBooks();
      closeReviewModal();
      showToast("Recensione salvata.");
    }

    function exportBackup() {
      try {
        const text = JSON.stringify(books, null, 2);
        $("backupArea").value = text;
        showToast("Backup generato. Copia il testo per salvarlo altrove.");
      } catch (e) {
        console.error(e);
        showToast("Errore nella generazione del backup.", true);
      }
    }

    function importBackup() {
      const text = $("backupArea").value.trim();
      if (!text) {
        showToast("Inserisci un contenuto JSON nel riquadro per importare.", true);
        return;
      }
      if (!confirm("Importando il backup sovrascriverai i dati attuali. Procedere?")) {
        return;
      }
      try {
        const parsed = JSON.parse(text);
        if (!Array.isArray(parsed)) {
          throw new Error("Formato non valido: ci si aspetta un array.");
        }
        books = parsed;
        saveBooks(books);
        renderBooks();
        showToast("Backup importato correttamente.");
      } catch (e) {
        console.error(e);
        showToast("Backup non valido: impossibile importare.", true);
      }
    }

    function clearAllData() {
      if (!confirm("ATTENZIONE: questa azione cancella tutti i libri e le recensioni. Continuare?")) {
        return;
      }
      books = [];
      saveBooks(books);
      renderBooks();
      $("backupArea").value = "";
      showToast("Tutti i dati sono stati cancellati.");
    }

    async function fetchBookData() {
      const isbn = $("isbn").value.trim();
      const title = $("title").value.trim();
      const author = $("author").value.trim();

      let q = "";
      if (isbn) {
        q = "isbn:" + encodeURIComponent(isbn);
      } else if (title || author) {
        const parts = [];
        if (title) parts.push("intitle:" + title);
        if (author) parts.push("inauthor:" + author);
        q = parts.join("+");
      } else {
        showToast("Inserisci almeno ISBN o titolo/autore per la ricerca.", true);
        return;
      }

      const url = "https://www.googleapis.com/books/v1/volumes?q=" + encodeURIComponent(q) + "&maxResults=1";

      try {
        showToast("Ricerca dati libro in corso‚Ä¶");
        const res = await fetch(url);
        if (!res.ok) throw new Error("Errore HTTP " + res.status);
        const data = await res.json();
        if (!data.items || !data.items.length) {
          showToast("Nessun risultato trovato su Google Books.", true);
          return;
        }
        const volume = data.items[0].volumeInfo || {};
        if (volume.title && !$("title").value.trim()) $("title").value = volume.title;
        if (volume.authors && volume.authors.length && !$("author").value.trim()) {
          $("author").value = volume.authors.join(", ");
        }
        if (volume.categories && volume.categories.length && !$("category").value.trim()) {
          $("category").value = volume.categories[0];
        }
        if (volume.pageCount && !$("pages").value.trim()) {
          $("pages").value = volume.pageCount;
        }

        if (volume.imageLinks && !$("coverUrl").value.trim()) {
          let img = volume.imageLinks.thumbnail || volume.imageLinks.smallThumbnail;
          if (img) {
            if (img.startsWith("http:")) {
              img = "https:" + img.slice(5);
            }
            $("coverUrl").value = img;
          }
        }

        showToast("Dati libro (e copertina) completati da Google Books.");
      } catch (e) {
        console.error(e);
        showToast("Impossibile recuperare i dati da Google Books.", true);
      }
    }

    function buildStoreSearchQuery() {
      const isbn = $("isbn").value.trim();
      const title = $("title").value.trim();
      const author = $("author").value.trim();

      let raw = "";
      if (isbn) {
        raw = isbn;
      } else if (title || author) {
        raw = title;
        if (author) raw += " " + author;
      } else {
        return null;
      }
      return encodeURIComponent(raw);
    }

    function openStoreSearch(store) {
      const q = buildStoreSearchQuery();
      if (!q) {
        showToast("Inserisci almeno titolo, autore o ISBN per cercare nelle librerie online.", true);
        return;
      }

      let url = "";
      switch (store) {
        case "amazon":
          url = "https://www.amazon.it/s?k=" + q;
          break;
        case "feltrinelli":
          url = "https://www.lafeltrinelli.it/search?q=" + q;
          break;
        case "ibs":
          url = "https://www.ibs.it/search/?ts=as&query=" + q;
          break;
        default:
          return;
      }

      window.open(url, "_blank", "noopener");
    }

    function initEvents() {
      $("addBookBtn").addEventListener("click", addBookFromForm);
      $("resetFormBtn").addEventListener("click", resetForm);
      $("fetchBookDataBtn").addEventListener("click", fetchBookData);

      $("exportBtn").addEventListener("click", exportBackup);
      $("importBtn").addEventListener("click", importBackup);
      $("clearAllBtn").addEventListener("click", clearAllData);

      $("reviewModalCloseBtn").addEventListener("click", closeReviewModal);
      $("saveReviewBtn").addEventListener("click", saveReview);
      $("reviewModalBackdrop").addEventListener("click", (e) => {
        if (e.target === $("reviewModalBackdrop")) {
          closeReviewModal();
        }
      });

      const tabs = document.querySelectorAll("#statusTabs .tab");
      tabs.forEach(tab => {
        tab.addEventListener("click", () => {
          tabs.forEach(t => t.classList.remove("active"));
          tab.classList.add("active");
          activeStatusFilter = tab.dataset.status;
          renderBooks();
        });
      });

      const searchInput = $("searchInput");
      if (searchInput) {
        searchInput.addEventListener("input", () => {
          searchQuery = searchInput.value.trim();
          renderBooks();
        });
      }

      const clearSearchBtn = $("clearSearchBtn");
      if (clearSearchBtn) {
        clearSearchBtn.addEventListener("click", () => {
          searchQuery = "";
          if (searchInput) searchInput.value = "";
          renderBooks();
          showToast("Ricerca azzerata.");
        });
      }

      const amazonBtn = $("amazonSearchBtn");
      if (amazonBtn) {
        amazonBtn.addEventListener("click", () => openStoreSearch("amazon"));
      }

      const feltrinelliBtn = $("feltrinelliSearchBtn");
      if (feltrinelliBtn) {
        feltrinelliBtn.addEventListener("click", () => openStoreSearch("feltrinelli"));
      }

      const ibsBtn = $("ibsSearchBtn");
      if (ibsBtn) {
        ibsBtn.addEventListener("click", () => openStoreSearch("ibs"));
      }
    }

    document.addEventListener("DOMContentLoaded", () => {
      initEvents();
      renderBooks();
      updateStats();
      updateCategoriesView();
    });

    /* Registrazione service worker per PWA */
    if ("serviceWorker" in navigator) {
      window.addEventListener("load", () => {
        navigator.serviceWorker
          .register("service-worker.js")
          .catch((err) => console.error("SW registration failed:", err));
      });
    }
  </script>
</body>
</html>
